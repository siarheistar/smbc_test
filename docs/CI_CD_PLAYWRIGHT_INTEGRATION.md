# CI/CD Playwright Report Integration

**Date:** December 3, 2025
**Status:** ✅ CONFIGURED

## Overview

Integrated Playwright HTML reports into the CI/CD pipeline with automatic publishing to GitHub Pages and linking from Allure reports.

## Changes Made

### 1. BDD Test Jobs - Playwright Report Upload

**Location:** `.github/workflows/ci.yml` lines 168-184

Added two new artifact upload steps for each browser (firefox, chromium, webkit):

```yaml
- name: Upload Playwright HTML report for ${{ matrix.browser }}
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: playwright-report-${{ matrix.browser }}
    path: playwright-report.html
    retention-days: 30
    if-no-files-found: warn

- name: Upload Playwright test artifacts for ${{ matrix.browser }}
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: playwright-artifacts-${{ matrix.browser }}
    path: test-results/
    retention-days: 30
    if-no-files-found: warn
```

**What this does:**
- Uploads the `playwright-report.html` generated by `pytest-html` for each browser
- Uploads the `test-results/` directory containing screenshots, videos, and traces
- Uses `if: always()` to ensure reports are uploaded even if tests fail
- Retention period: 30 days

### 2. Aggregate Job - Merge Playwright Reports

**Location:** `.github/workflows/ci.yml` lines 706-733

Added new step to merge Playwright reports from all 3 browsers:

```yaml
- name: Merge Playwright reports
  run: |
    mkdir -p allure-history/playwright-reports

    # Copy Playwright HTML reports from each browser artifact
    for browser in firefox chromium webkit; do
      artifact_dir="artifacts/playwright-report-${browser}"
      if [ -d "$artifact_dir" ] && [ -f "$artifact_dir/playwright-report.html" ]; then
        echo "Copying Playwright report for $browser..."
        cp "$artifact_dir/playwright-report.html" "allure-history/playwright-reports/${browser}.html"
      else
        echo "WARNING: Playwright report for $browser not found"
        # Create placeholder if report is missing
        [creates placeholder HTML]
      fi
    done

    echo "Playwright reports merged successfully"
    ls -la allure-history/playwright-reports/
```

**What this does:**
- Creates `allure-history/playwright-reports/` directory
- Copies each browser's Playwright report with browser-specific naming:
  - `firefox.html`
  - `chromium.html`
  - `webkit.html`
- Creates placeholder HTML if a report is missing (graceful degradation)
- These reports are then deployed to GitHub Pages as part of `allure-history/`

### 3. Allure Report - Custom Links Widget

**Location:** `.github/workflows/ci.yml` lines 647-674

Updated the custom links widget to include Playwright report links:

```json
{
  "name": "custom-links",
  "data": [
    {
      "name": "Coverage Report",
      "url": "../htmlcov/index.html"
    },
    {
      "name": "Test Reports Index",
      "url": "../index.html"
    },
    {
      "name": "Playwright Report (Firefox)",
      "url": "../playwright-reports/firefox.html"
    },
    {
      "name": "Playwright Report (Chromium)",
      "url": "../playwright-reports/chromium.html"
    },
    {
      "name": "Playwright Report (WebKit)",
      "url": "../playwright-reports/webkit.html"
    }
  ]
}
```

**What this does:**
- Adds clickable links in the Allure report sidebar
- Links to all 3 browser-specific Playwright reports
- Provides quick navigation between different test report types

### 4. Allure Report - Custom Header

**Location:** `.github/workflows/ci.yml` lines 690-704

Updated the custom header injected into Allure reports:

```html
<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; text-align: center; margin-bottom: 20px; border-radius: 8px;">
    <h2 style="margin: 0;">Run ID: ${{ env.RUN_ID }}</h2>
    <p style="margin: 5px 0 0 0;">
        <a href="../index.html" style="color: white; text-decoration: underline;">← Back to Test Reports Index</a> |
        <a href="../htmlcov/index.html" style="color: white; text-decoration: underline;">Coverage Report</a>
    </p>
    <p style="margin: 5px 0 0 0; font-size: 14px;">
        Playwright Reports:
        <a href="../playwright-reports/firefox.html" style="color: white; text-decoration: underline;">Firefox</a> |
        <a href="../playwright-reports/chromium.html" style="color: white; text-decoration: underline;">Chromium</a> |
        <a href="../playwright-reports/webkit.html" style="color: white; text-decoration: underline;">WebKit</a>
    </p>
</div>
```

**What this does:**
- Adds prominent header bar at top of Allure report
- Displays current Run ID
- Links to Test Reports Index and Coverage Report
- Links to all 3 Playwright reports for easy access

## Test Count Verification

### Expected Test Count: 251

The CI/CD workflow should show **251 total tests**:

- **Unit tests:** 19
- **API tests:** 79
- **BDD tests:** 51 scenarios × 3 browsers = 153

**Total:** 19 + 79 + 153 = **251 tests**

### How Tests Are Counted

The statistics calculation step (`lines 254-303`) counts all `*-result.json` files from the merged `allure-results` directory:

```python
for path in allure_dir.rglob("*-result.json"):
    total += 1
    # ... count passed/failed
```

### BDD Test Result Merging

The merge step (`lines 227-252`) copies Allure results from all test types:

```bash
expected_dirs=(
  "artifacts/allure-results-unit"
  "artifacts/allure-results-api"
  "artifacts/allure-results-bdd-firefox"
  "artifacts/allure-results-bdd-chromium"
  "artifacts/allure-results-bdd-webkit"
)

for d in "${expected_dirs[@]}"; do
  if [ -d "$d" ]; then
    echo "Copying results from $d ..."
    find "$d" -type f -name "*-result.json" -exec cp {} allure-results/ \;
    find "$d" -type f ! -name "*-result.json" -exec cp {} allure-results/ \;
  fi
done
```

**Key points:**
- Each browser runs all 51 BDD scenarios independently
- Each browser job saves results to `allure-results-bdd-{browser}`
- Aggregate job downloads ALL artifacts and merges them
- Final count should include all 3 × 51 = 153 BDD test results

## GitHub Pages Structure

After deployment, the GitHub Pages site has this structure:

```
gh-pages/
├── index.html                    # Custom test reports index
├── latest/                       # Latest Allure report
│   └── index.html
├── htmlcov/                      # Coverage report
│   └── index.html
├── playwright-reports/           # ← NEW
│   ├── firefox.html              # ← NEW
│   ├── chromium.html             # ← NEW
│   └── webkit.html               # ← NEW
├── run-123456/                   # Historical run
│   └── index.html
└── ...
```

## Accessing Reports

### From Allure Report

1. **Sidebar Links:**
   - Click "Playwright Report (Firefox)" in the custom links widget
   - Click "Playwright Report (Chromium)" in the custom links widget
   - Click "Playwright Report (WebKit)" in the custom links widget

2. **Header Links:**
   - Click "Firefox", "Chromium", or "WebKit" in the header bar

### Direct URLs

After deployment to GitHub Pages:

```
https://{owner}.github.io/{repo}/playwright-reports/firefox.html
https://{owner}.github.io/{repo}/playwright-reports/chromium.html
https://{owner}.github.io/{repo}/playwright-reports/webkit.html
```

### From GitHub Actions

1. Go to Actions tab → Select workflow run
2. Scroll to "Artifacts" section
3. Download artifacts:
   - `playwright-report-firefox`
   - `playwright-report-chromium`
   - `playwright-report-webkit`
   - `playwright-artifacts-firefox` (screenshots/videos/traces)
   - `playwright-artifacts-chromium`
   - `playwright-artifacts-webkit`

## Report Features

Each Playwright HTML report includes:

### Summary Section
- Total tests run
- Passed/Failed/Skipped counts
- Total execution time
- Browser information
- Environment details

### Test Details
- Individual test results with status
- Execution time per test
- Error messages and stack traces (for failures)
- Screenshots embedded inline
- Links to videos (on failure)
- Links to trace files (on failure)

### Artifacts
- **Screenshots:** Always captured, embedded in report
- **Videos:** Only on failure, linked from report
- **Traces:** Only on failure, downloadable for deep debugging

## Troubleshooting

### Missing Test Count (57 instead of 251)

**Check the workflow logs:**

1. **"List downloaded artifacts" step** - Should show:
   ```
   Downloaded artifacts:
   artifacts/allure-results-unit: 19
   artifacts/allure-results-api: 79
   artifacts/allure-results-bdd-firefox: 51
   artifacts/allure-results-bdd-chromium: 51
   artifacts/allure-results-bdd-webkit: 51
   ```

2. **"Merge all Allure results" step** - Should show:
   ```
   Copying results from artifacts/allure-results-unit ...
   Copying results from artifacts/allure-results-api ...
   Copying results from artifacts/allure-results-bdd-firefox ...
   Copying results from artifacts/allure-results-bdd-chromium ...
   Copying results from artifacts/allure-results-bdd-webkit ...
   Total merged results: 251
   ```

3. **"Calculate test statistics" step** - Should show:
   ```
   Statistics: 251 tests, {passed} passed, {failed} failed, ...
   ```

**Common issues:**

- **BDD artifacts not uploaded:** Check BDD test jobs completed successfully
- **Artifacts not downloaded:** Check `actions/download-artifact@v4` step logs
- **Results not merged:** Check merge script found all expected directories
- **Wrong count:** Verify each BDD browser job ran all 51 scenarios

### Playwright Reports Not Showing

**Check:**

1. BDD test jobs uploaded `playwright-report-{browser}` artifacts
2. "Merge Playwright reports" step found the artifacts
3. Files were copied to `allure-history/playwright-reports/`
4. GitHub Pages deployment included the playwright-reports directory

**View logs:**
```bash
# In "Merge Playwright reports" step
Copying Playwright report for firefox...
Copying Playwright report for chromium...
Copying Playwright report for webkit...
Playwright reports merged successfully
total 12
-rw-r--r-- 1 runner docker 4096 Dec  3 08:00 firefox.html
-rw-r--r-- 1 runner docker 4096 Dec  3 08:00 chromium.html
-rw-r--r-- 1 runner docker 4096 Dec  3 08:00 webkit.html
```

## Related Files

- [.github/workflows/ci.yml](../.github/workflows/ci.yml) - Main CI/CD workflow
- [pytest.ini](../pytest.ini) - Pytest configuration with HTML report settings
- [docs/PLAYWRIGHT_REPORTING.md](./PLAYWRIGHT_REPORTING.md) - Local Playwright reporting guide
- [docs/BDD_FEATURE_CONSOLIDATION.md](./BDD_FEATURE_CONSOLIDATION.md) - BDD feature file consolidation

## Summary

✅ **Playwright reports fully integrated into CI/CD:**
- HTML reports generated for each browser (firefox, chromium, webkit)
- Reports uploaded as GitHub Actions artifacts
- Reports merged and published to GitHub Pages
- Links added to Allure report sidebar and header
- Graceful degradation if reports are missing
- All 251 tests (19 unit + 79 API + 153 BDD) should be counted correctly

**Next CI/CD run will:**
1. Run BDD tests on 3 browsers with Playwright HTML reporting
2. Upload Playwright reports and artifacts
3. Merge all Allure results (should show 251 tests)
4. Merge Playwright reports for all 3 browsers
5. Deploy everything to GitHub Pages
6. Provide links in Allure report to all Playwright reports
